<!DOCTYPE html>
<html>
<head>
    <title>FeatureBoard1</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.example.SpecificColumnsBoard",{extend:"Rally.app.App",items:[{xtype:"container",itemId:"header"},{xtype:"container",itemId:"main"}],cardHeight:140,cardWidth:220,launch:function(){this.down("#header").add({xtype:"rallyreleasecombobox",fieldLabel:"Filter by Release:",project:this.getContext().getProject(),value:Rally.util.Ref.getRelativeUri(this.getContext().getTimeboxScope()),listeners:{select:this._onLoad,ready:this._onLoad,scope:this}})},_makeUserStoryCard:function(e,t,o){var r=null==e.get("Iteration")?"Not Scheduled":e.get("Iteration").Name,s=null==e.get("Owner")?"No Owner":e.get("Owner")._refObjectName,a='<div style="border: 1px solid black; margin-bottom: 5px; height: '+this.cardHeight+'px; overflow: auto"><div><div style="padding-left: 3px; padding-right: 3px; overflow: auto; background: LightBlue"><div style="float: left"><a style="color: black; text-decoration: underline" href="'+Rally.nav.Manager.getDetailUrl(e)+'">'+e.get("FormattedID")+"</a>&nbsp;&nbsp;&nbsp;"+e.get("PlanEstimate")+' Points</div><div style="float: right">'+e.get("ScheduleState")+'</div></div><div style="padding-left: 10px; padding-right: 10px;"><p>'+e.get("Name")+"</p><div>"+s+"</div><div>"+r+"</div><div>"+e.get("Project").Name+"</div></div></div></div>";return Ext.create("Ext.Component",{html:a,width:this.cardWidth,style:{left:t+"px",top:o+"px",position:"absolute"},renderTo:Ext.getBody()})},_makeFeatureCard:function(e,t,o){var r=null==e.get("PreliminaryEstimate")?"None":e.get("PreliminaryEstimate").Name,s=null==e.get("State")?"None":e.get("State").Name,a=null==e.get("Owner")?"None":e.get("Owner")._refObjectName,i='<div style="border: 1px solid black;"><div><div style="padding-left: 3px; padding-right: 3px; overflow: auto; background: GoldenRod"><div style="float: left">'+e.get("FormattedID")+"&nbsp;&nbsp;&nbsp;Est:"+r+'</div><div style="float: right">'+s+'</div></div><div style="padding-left: 10px; padding-right: 10px;"><p>'+e.get("Name")+"</p><div>"+a+"</div></div></div></div></div>";return Ext.create("Ext.Component",{html:i,width:this.cardWidth,style:{left:t+"px",top:o+"px",position:"absolute"},renderTo:Ext.getBody()})},_makeLineBetweenCards:function(e,t){var o=e.style.left,r=e.style.top,s=Number(o.substring(0,o.length-2))+this.cardWidth,a=Number(r.substring(0,r.length-2))+50;o=t.style.left,r=t.style.top;var i,n,l=Number(o.substring(0,o.length-2)),d=Number(r.substring(0,r.length-2))+50,c=Math.abs(l-s),u=Math.abs(d-a),g=c;l>s?(o=s,d>a?(r=a,i=0,n=u):(r=d,i=u,n=-1*u)):(o=l,d>a?(r=a,i=u,n=-1*u):(r=d,i=0,n=u)),console.log("top",r),console.log("left",o),console.log("deltaX",c),console.log("deltaY",u),console.log("startX",0),console.log("startY",i),console.log("endX",g),console.log("endY",n);var h='<svg width="'+c+'" height="'+u+'"><g fill="none" stroke="black" stroke-width="1"><path stroke-dasharray="5,5" d="M0 '+i+" l"+g+" "+n+'" /></g>Sorry, your browser does not support inline SVG.</svg>';return Ext.create("Ext.Component",{html:h,style:{left:o+"px",top:r+"px",position:"absolute"},renderTo:Ext.getBody()})},_onLoad:function(){Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/Feature",autoLoad:!0,filters:[{property:"Release",operator:"=",value:this.down("rallyreleasecombobox").getValue()}],listeners:{load:this._onFeaturesLoaded,scope:this},sorters:[{property:"Rank"}]})},_onSelect:function(){},features:[],gIterations:[],_onFeaturesLoaded:function(e,t){var o=this,r=e.count(),s=0;this.gIterations.push({name:"Not Scheduled",startDate:new Date(0)}),_.each(t,function(e){var t={featureModel:e,iterations:[]};t.iterations.push({name:"Not Scheduled",userStories:[]}),o.features.push(t),e.getCollection("UserStories").load({fetch:["FormattedID","Name","Owner","PlanEstimate","ScheduleState","Project","Iteration","StartDate","Successors","Predecessors","Defects"],callback:function(e,a,i){var n=e.length,l=0;s++,Ext.Array.each(e,function(e){l++;var a=e.get("Iteration");if(null==a)t.iterations[0].userStories.push(e),console.log("unscheduled",e);else{for(var i=!1,d=!1,c=0;c<o.gIterations.length;c++)if(o.gIterations[c].name==a._refObjectName){d=!0;break}d||(o.gIterations.push({name:a._refObjectName,startDate:a.StartDate}),i=!0,console.log("new global iteration",a));var u=!1,g=0;if(!i)for(;g<t.iterations.length;g++)if(t.iterations[g].name==a._refObjectName){u=!0;break}if(!i&&u||(i=!0),i){var h={name:a._refObjectName,userStories:[]};h.userStories.push(e),t.iterations.push(h)}else t.iterations[g].userStories.push(e)}1==s&&console.log("feature 1",o.features[1]),l==n&&s==r&&(o.gIterations.sort(function(e,t){return e.startDate>t.startDate}),console.log("featureCount",s),o._renderFeatures())})},scope:this})})},_loadChildren:function(e){var t=[];return _.each(e,function(e){var o=e.get("Defects");o.Count>0&&(o.store=e.getCollection("Defects"),t.push(o.store.load()));var r=e.get("Predecessors");r.Count>0&&(r.store=e.getCollection("Predecessors"),t.push(r.store.load()));var s=e.get("Successors");s.Count>0&&(s.store=e.getCollection("Successors"),t.push(s.store.load()))}),Deft.Promise.all(t)},_getDefects:function(e){return e.getCollection("Defects").load({fetch:["FormattedID"]})},_getPredecessors:function(e){return e.getCollection("Predecessors").load({fetch:["FormattedID"],callback:function(t,o,r){e.predecessors=t}}),e},_getSuccessors:function(e){return e.getCollection("Successors").load({fetch:["FormattedID"],callback:function(t,o,r){e.successors=t}}),e},predecessorCards:[],successorCards:[],_renderFeatures:function(){console.log("render time");for(var e='<div><div style="position: absolute; left: 0px; top: 0px;">Iterations</div>',t=0;t<this.gIterations.length;t++)e+='<div style="width: '+this.cardWidth+"px; position: absolute; left: "+this.cardWidth*(t+1)+'px; top: 0px">'+this.gIterations[t].name+"</div>";e+="</div>";var o=Ext.create("Ext.Component",{html:e,style:{left:"20px",top:"60px",position:"absolute"},renderTo:Ext.getBody()});this.down("#main").add(o),console.log("about to load cards");for(var r=200,s=this.features.length,a=0;a<s;a++){var i=this.features[a];this.down("#main").add(this._makeFeatureCard(i.featureModel,0,r));for(var n=r,l=i.iterations.length,d=0;d<l;d++){for(var c=i.iterations[d],u=r,g=c.userStories.length,h=0;h<g;h++)for(var p=c.userStories[h],f=0;f<this.gIterations.length;f++){if((null==p.get("Iteration")?"Not Scheduled":p.get("Iteration").Name)==this.gIterations[f].name){var m=this._makeUserStoryCard(p,this.cardWidth*(f+1),u);p.get("Successors").Count>0&&this._addToPredecessors(m,p),p.get("Predecessors").Count>0&&this._addToSuccessors(m,p),this.down("#main").add(m),u+=this.cardHeight;break}}u>n&&(n=u)}r=n+this.cardHeight}},_addToPredecessors:function(e,t){var o=this;t.getCollection("Successors").load({fetch:["FormattedID"],callback:function(r,s,a){Ext.Array.each(r,function(r){o.predecessorCards.push({card:e,storyId:t.get("FormattedID"),successorId:r.get("FormattedID")})})}})},_addToSuccessors:function(e,t){var o=this;t.getCollection("Predecessors").load({fetch:["FormattedID"],callback:function(r,s,a){Ext.Array.each(r,function(r){o.successorCards.push({card:e,storyId:t.get("FormattedID"),predecessorId:r.get("FormattedID")})})}})}}),Rally.launchApp("Rally.example.SpecificColumnsBoard",{name:"Specific Columns Board Example"});

            Rally.launchApp('CustomApp', {
                name:"FeatureBoard1",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
